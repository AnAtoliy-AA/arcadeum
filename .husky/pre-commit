#!/usr/bin/env sh

set -e

# Check if package.json has dependency or version changes
PKG_JSON_CHANGES=$(git diff --cached package.json | grep -E '^\+.*"(version|dependencies|devDependencies|peerDependencies|optionalDependencies)"' || true)
STAGED_LOCKFILE=$(git diff --cached --name-only | grep 'pnpm-lock.yaml' || true)

if [ -n "$PKG_JSON_CHANGES" ] && [ -z "$STAGED_LOCKFILE" ]; then
  echo "⚠️  Warning: package.json dependencies or version changed but pnpm-lock.yaml wasn't updated."
  echo "   This may cause deployment failures with frozen-lockfile."
  echo ""
  echo "   If you added/removed dependencies, run:"
  echo "     pnpm install"
  echo "     git add pnpm-lock.yaml"
  echo ""
  echo "   If this is intentional, you can continue."
  read -p "   Continue anyway? [y/N] " answer
  if [ "$answer" != "y" ] && [ "$answer" != "Y" ]; then
    echo "❌ Commit aborted. Please update the lockfile."
    exit 1
  fi
fi

npm run check-file-length

# Check translations
echo "Checking translations..."
node scripts/check_translation.js || {
  echo "❌ Translation validation failed. Please fix missing translation keys."
  exit 1
}

pnpm exec lint-staged

# Check staged TypeScript files for 'any' type violations
# This runs ESLint on staged files after lint-staged to ensure any types are caught
# even if they were added during formatting/fixing phase (unlikely but safe)
STAGED_TS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx)$' || true)

if [ -n "$STAGED_TS_FILES" ]; then
  echo "Checking staged TypeScript files for type errors..."
  
  # Check backend files
  BE_FILES=$(echo "$STAGED_TS_FILES" | grep '^apps/be/' || true)
  if [ -n "$BE_FILES" ]; then
    cd apps/be
    echo "$BE_FILES" | sed 's|^apps/be/||' | xargs -I {} pnpm exec eslint --max-warnings=0 --no-fix "{}" || {
      echo "❌ ESLint found errors in backend files. Please fix them before committing."
      exit 1
    }
    cd ../..
  fi
  
  # Check web files
  WEB_FILES=$(echo "$STAGED_TS_FILES" | grep '^apps/web/' || true)
  if [ -n "$WEB_FILES" ]; then
    cd apps/web
    echo "$WEB_FILES" | sed 's|^apps/web/||' | xargs -I {} pnpm exec eslint --max-warnings=0 --no-fix "{}" || {
      echo "❌ ESLint found errors in web files. Please fix them before committing."
      exit 1
    }
    cd ../..
  fi
  
  # Check mobile files
  MOBILE_FILES=$(echo "$STAGED_TS_FILES" | grep '^apps/mobile/' || true)
  if [ -n "$MOBILE_FILES" ]; then
    cd apps/mobile
    echo "$MOBILE_FILES" | sed 's|^apps/mobile/||' | xargs -I {} pnpm exec eslint --max-warnings=0 --no-fix "{}" || {
      echo "❌ ESLint found errors in mobile files. Please fix them before committing."
      exit 1
    }
    cd ../..
  fi
  
  echo "✅ TypeScript files passed ESLint checks"
fi

echo "Running build..."
npm run build

# Run backend unit tests before commiting
echo "Running backend unit tests..."
cd apps/be
pnpm run test || {
  echo "❌ Backend unit tests failed. Please fix them before commiting."
  exit 1
}
cd ../..
echo "✅ Backend unit tests passed"

# Run web unit tests before commiting
echo "Running web unit tests..."
cd apps/web
pnpm run test || {
  echo "❌ Web unit tests failed. Please fix them before commiting."
  exit 1
}
cd ../..
echo "✅ Web unit tests passed"

# Run web e2e tests before commiting
echo "Running e2e tests..."
cd apps/web
pnpm run test:e2e || {
  echo "❌ E2E tests failed. Please fix them before commiting."
  exit 1
}
cd ../..
echo "✅ E2E tests passed"
