#!/usr/bin/env sh

set -e

npm run check-file-length

pnpm exec lint-staged

# Check staged TypeScript files for 'any' type violations
# This runs ESLint on staged files after lint-staged to ensure any types are caught
# even if they were added during formatting/fixing phase (unlikely but safe)
STAGED_TS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx)$' || true)

if [ -n "$STAGED_TS_FILES" ]; then
  echo "Checking staged TypeScript files for type errors..."
  
  # Check backend files
  BE_FILES=$(echo "$STAGED_TS_FILES" | grep '^apps/be/' || true)
  if [ -n "$BE_FILES" ]; then
    cd apps/be
    echo "$BE_FILES" | sed 's|^apps/be/||' | xargs -I {} pnpm exec eslint --max-warnings=0 --no-fix "{}" || {
      echo "❌ ESLint found errors in backend files. Please fix them before committing."
      exit 1
    }
    cd ../..
  fi
  
  # Check web files
  WEB_FILES=$(echo "$STAGED_TS_FILES" | grep '^apps/web/' || true)
  if [ -n "$WEB_FILES" ]; then
    cd apps/web
    echo "$WEB_FILES" | sed 's|^apps/web/||' | xargs -I {} pnpm exec eslint --max-warnings=0 --no-fix "{}" || {
      echo "❌ ESLint found errors in web files. Please fix them before committing."
      exit 1
    }
    cd ../..
  fi
  
  # Check mobile files
  MOBILE_FILES=$(echo "$STAGED_TS_FILES" | grep '^apps/mobile/' || true)
  if [ -n "$MOBILE_FILES" ]; then
    cd apps/mobile
    echo "$MOBILE_FILES" | sed 's|^apps/mobile/||' | xargs -I {} pnpm exec eslint --max-warnings=0 --no-fix "{}" || {
      echo "❌ ESLint found errors in mobile files. Please fix them before committing."
      exit 1
    }
    cd ../..
  fi
  
  echo "✅ TypeScript files passed ESLint checks"
fi

echo "Running build..."
npm run build
